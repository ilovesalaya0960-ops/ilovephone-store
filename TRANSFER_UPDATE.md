# 🔄 อัพเดท: ฟังก์ชัน "ตัดสลับร้านตัวเอง"

## 📋 สรุปการเปลี่ยนแปลง

เปลี่ยนพฤติกรรมของฟังก์ชัน "ตัดสลับไปร้านตัวเอง" จากการย้ายเครื่องจริง เป็นการบันทึกในเมนู "ตัดออก" พร้อมระบุปลายทาง

## 🎯 เหตุผลในการเปลี่ยน

### ❌ พฤติกรรมเดิม (ก่อนแก้ไข)
```
คลิก "ตัด" → เลือก "ตัดสลับไปร้านตัวเอง"
   ↓
ย้ายข้อมูลไปร้านอื่น (เปลี่ยน store)
   ↓
เครื่องไปอยู่สต๊อคของร้านปลายทาง (status = 'stock')
   ↓
❌ ไม่มีบันทึกในร้านต้นทาง
❌ ไม่รู้ว่าเครื่องไปไหน
```

**ปัญหา:**
- ร้านต้นทางไม่มีบันทึกว่าตัดเครื่องไปไหน
- ไม่สามารถติดตามย้อนหลังได้
- ไม่มีหลักฐานการย้าย

### ✅ พฤติกรรมใหม่ (หลังแก้ไข)
```
คลิก "ตัด" → เลือก "ตัดสลับไปร้านตัวเอง"
   ↓
บันทึกในเมนู "ตัดออก" ของร้านต้นทาง (status = 'removed')
   ↓
ระบุ note: "ตัดสลับไปร้าน XXX"
   ↓
ใช้ราคาขายเดิม (ไม่ต้องแก้ไข)
   ↓
✅ มีบันทึกในร้านต้นทาง
✅ รู้ว่าเครื่องไปไหน
✅ สามารถติดตามย้อนหลังได้
```

## 🆚 เปรียบเทียบ 2 ประเภท

### 1️⃣ ตัดขายให้เจ้าอื่น

```
┌─────────────────────────────────────┐
│  📝 แก้ไขราคาและหมายเหตุ            │
├─────────────────────────────────────┤
│  📱 Samsung Galaxy S23              │
│  💰 ราคาทุน: ฿15,000                │
│  💵 ราคาขายตั้งไว้: ฿19,000         │
│                                     │
│  ราคาขายจริง: [18000] ←แก้ไขได้    │
│                                     │
│  ➕ กำไร: ฿3,000 (20.00%)           │
│                                     │
│  หมายเหตุ:                          │
│  [ขายให้ร้านXXX ราคา 18,000]       │
│                                     │
│  [ยกเลิก]  [✅ บันทึก]              │
└─────────────────────────────────────┘
```

**ฟีเจอร์:**
- ✅ **แก้ไขราคาขายได้** (เพราะขายจริง)
- ✅ คำนวณกำไร/ขาดทุน
- ✅ กรอกหมายเหตุได้
- ✅ บันทึกใน Tab "ตัดออก"
- ✅ ตั้ง sale_date = วันที่ปัจจุบัน

**ผลลัพธ์ในฐานข้อมูล:**
```javascript
{
  status: 'removed',
  sale_price: 18000,        // ราคาที่แก้ไข
  sale_date: '2025-10-31',
  note: 'ขายให้ร้านXXX ราคา 18,000'
}
```

### 2️⃣ ตัดสลับไปร้านตัวเอง (ใหม่!)

```
┌─────────────────────────────────────┐
│  Confirm Dialog                     │
├─────────────────────────────────────┤
│  🔄 ตัดสลับไปร้าน คลองโยง?         │
│                                     │
│  ✅ บันทึกในเมนู "ตัดออก"          │
│  ✅ ระบุว่าย้ายไป: ร้านคลองโยง      │
│  ✅ ราคาขายคงเดิม (ไม่ต้องแก้ไข)   │
│  ℹ️ เครื่องจะแสดงใน Tab "ตัดออก"   │
│                                     │
│  [ยกเลิก]  [ตกลง]                  │
└─────────────────────────────────────┘
```

**ฟีเจอร์:**
- ✅ **ไม่ต้องแก้ไขราคา** (เพราะไม่ได้ขาย แค่ย้าย)
- ✅ ระบุปลายทางอัตโนมัติ
- ✅ บันทึกใน Tab "ตัดออก"
- ✅ ตั้ง sale_date = วันที่ปัจจุบัน
- ✅ note = "ตัดสลับไปร้าน XXX"

**ผลลัพธ์ในฐานข้อมูล:**
```javascript
{
  status: 'removed',
  sale_price: 19000,       // ราคาเดิม (ไม่เปลี่ยน)
  sale_date: '2025-10-31',
  note: 'ตัดสลับไปร้านคลองโยง'
}
```

## 📊 สรุปความแตกต่าง

| รายการ | ตัดขายให้เจ้าอื่น | ตัดสลับร้านตัวเอง |
|--------|------------------|------------------|
| **Modal** | มี (แก้ไขราคา) | ไม่มี (Confirm อย่างเดียว) |
| **แก้ไขราคา** | ✅ ได้ | ❌ ใช้ราคาเดิม |
| **คำนวณกำไร** | ✅ แสดง | ❌ ไม่แสดง |
| **หมายเหตุ** | พิมพ์เองได้ | สร้างอัตโนมัติ |
| **บันทึกใน "ตัดออก"** | ✅ | ✅ |
| **sale_date** | ✅ ตั้ง | ✅ ตั้ง |
| **ประเภทการใช้งาน** | ขายจริงให้เจ้าอื่น | ย้ายไปร้านตัวเอง |

## 🔄 Flow การทำงาน

### Flow: ตัดสลับไปร้านตัวเอง

```
1. ผู้ใช้คลิกปุ่ม "ตัด"
   ↓
2. markAsRemoved(deviceId) / markUsedAsRemoved(deviceId)
   ↓
3. แสดง Modal เลือกประเภท
   ├─ 🏪 ตัดขายให้เจ้าอื่น
   └─ 🔄 ตัดสลับไปร้านตัวเอง ← เลือกนี้
   ↓
4. selectRemoveOption('transfer')
   ↓
5. confirmTransferToOtherStore(device, deviceId)
   ↓
6. คำนวณร้านปลายทาง
   - ถ้าอยู่ศาลายา → ปลายทาง = คลองโยง
   - ถ้าอยู่คลองโยง → ปลายทาง = ศาลายา
   ↓
7. แสดง Confirm Dialog
   "🔄 ตัดสลับไปร้าน XXX?"
   ↓
8. ผู้ใช้คลิก "ตกลง"
   ↓
9. บันทึกลง Database:
   {
     status: 'removed',
     sale_date: วันที่ปัจจุบัน,
     note: 'ตัดสลับไปร้าน XXX'
   }
   ↓
10. โหลดข้อมูลใหม่
    ↓
11. แสดง Notification
    "✅ ตัดสลับไปร้าน XXX สำเร็จ (บันทึกในตัดออก)"
    ↓
12. เครื่องแสดงใน Tab "ตัดออก"
    - วันที่ขาย: วันที่ปัจจุบัน
    - ราคาขาย: ราคาเดิม
    - หมายเหตุ: "ตัดสลับไปร้านคลองโยง"
```

## 📝 ตัวอย่างการใช้งาน

### สถานการณ์ 1: ตัดสลับไปร้านคลองโยง

**ข้อมูลเครื่อง:**
- ยี่ห้อ: Samsung
- รุ่น: Galaxy S23
- ราคาทุน: ฿15,000
- ราคาขายตั้งไว้: ฿19,000
- ร้านปัจจุบัน: ศาลายา

**ขั้นตอน:**
1. คลิกปุ่ม "ตัด"
2. เลือก "ตัดสลับไปร้านตัวเอง"
3. Confirm: "ตัดสลับไปร้านคลองโยง?"
4. คลิก "ตกลง"

**ผลลัพธ์:**
```
Tab "ตัดออก" (ร้านศาลายา):
┌────────────────────────────────────────────────────────────┐
│ ยี่ห้อ: Samsung                                             │
│ รุ่น: Galaxy S23                                           │
│ ราคาทุน: ฿15,000                                           │
│ ราคาขาย: ฿19,000 ← ราคาเดิม (ไม่เปลี่ยน)                  │
│ วันที่ขาย: 1 พ.ย. 2568                                    │
│ กำไร: ฿4,000                                               │
│ หมายเหตุ: ตัดสลับไปร้านคลองโยง ← บันทึกอัตโนมัติ          │
└────────────────────────────────────────────────────────────┘
```

### สถานการณ์ 2: ตัดขายให้เจ้าอื่น (เปรียบเทียบ)

**ขั้นตอน:**
1. คลิกปุ่ม "ตัด"
2. เลือก "ตัดขายให้เจ้าอื่น"
3. Modal เปิด → แก้ไขราคาเป็น ฿18,000
4. กรอกหมายเหตุ: "ขายให้ร้านXXX ลดราคา"
5. คลิก "บันทึก"

**ผลลัพธ์:**
```
Tab "ตัดออก":
┌────────────────────────────────────────────────────────────┐
│ ยี่ห้อ: Samsung                                             │
│ รุ่น: Galaxy S23                                           │
│ ราคาทุน: ฿15,000                                           │
│ ราคาขาย: ฿18,000 ← ราคาที่แก้ไข                           │
│ วันที่ขาย: 1 พ.ย. 2568                                    │
│ กำไร: ฿3,000                                               │
│ หมายเหตุ: ขายให้ร้านXXX ลดราคา ← กรอกเอง                  │
└────────────────────────────────────────────────────────────┘
```

## 🎨 UI ที่เกี่ยวข้อง

### Confirm Dialog (ตัดสลับร้านตัวเอง)

```
╔═══════════════════════════════════════╗
║  🔄 ตัดสลับไปร้านคลองโยง?             ║
╠═══════════════════════════════════════╣
║                                       ║
║  ✅ บันทึกในเมนู "ตัดออก"            ║
║  ✅ ระบุว่าย้ายไป: ร้านคลองโยง        ║
║  ✅ ราคาขายคงเดิม (ไม่ต้องแก้ไข)     ║
║  ℹ️ เครื่องจะแสดงใน Tab "ตัดออก"     ║
║                                       ║
║  [ ยกเลิก ]      [ ตกลง ]            ║
╚═══════════════════════════════════════╝
```

### Tab "ตัดออก" - แสดงผล

```
┌───────────────────────────────────────────────────────────────────────────┐
│ ยี่ห้อ │ รุ่น      │ สี    │ IMEI │ RAM/ROM │ ราคาทุน │ ราคาขาย │ วันที่ขาย │
├───────────────────────────────────────────────────────────────────────────┤
│ Samsung│ Galaxy S23│ Black │ 6737 │ 8/256 GB│ ฿15,000 │ ฿19,000 │ 1 พ.ย.68│
│                                                                           │
│ กำไร │ หมายเหตุ                              │ การจัดการ                 │
├───────────────────────────────────────────────────────────────────────────┤
│ ฿4K  │ ตัดสลับไปร้านคลองโยง                  │ [↩ ย้ายกลับสต๊อค] [แก้ไข]│
└───────────────────────────────────────────────────────────────────────────┘
```

## ✅ ประโยชน์ที่ได้

### 1. **การติดตามย้อนหลัง**
- ✅ รู้ว่าเครื่องไหนถูกตัดไปร้านไหน
- ✅ มีบันทึกในร้านต้นทาง
- ✅ สามารถตรวจสอบประวัติได้

### 2. **การจัดการสต๊อค**
- ✅ นับสต๊อคชัดเจน (เครื่องที่ตัดไปแล้วนับเป็น removed)
- ✅ Dashboard แสดงผลถูกต้อง
- ✅ รายงานครบถ้วน

### 3. **การตรวจสอบทางบัญชี**
- ✅ มีหลักฐานการย้าย
- ✅ คำนวณกำไร/ขาดทุนได้
- ✅ ตรวจสอบย้อนหลังได้

### 4. **ความสอดคล้อง**
- ✅ ทุกเครื่องที่ตัด จะอยู่ใน Tab "ตัดออก"
- ✅ ไม่มีเครื่อง "หาย" จากระบบ
- ✅ ง่ายต่อการบริหารจัดการ

## 🔍 เปรียบเทียบก่อน-หลัง

### ตัวอย่าง: เครื่อง Samsung Galaxy S23 (ร้านศาลายา)

**ก่อนแก้ไข:**
```
[ร้านศาลายา - Tab สต๊อค]
- Samsung Galaxy S23 ✅

↓ คลิก "ตัด" → "ตัดสลับร้านตัวเอง"

[ร้านศาลายา - Tab สต๊อค]
- (ว่างเปล่า)

[ร้านคลองโยง - Tab สต๊อค]
- Samsung Galaxy S23 ✅ ← ย้ายมาที่นี่

❌ ร้านศาลายาไม่มีบันทึก
❌ ไม่รู้ว่าเครื่องไปไหน
```

**หลังแก้ไข:**
```
[ร้านศาลายา - Tab สต๊อค]
- Samsung Galaxy S23 ✅

↓ คลิก "ตัด" → "ตัดสลับร้านตัวเอง"

[ร้านศาลายา - Tab ตัดออก]
- Samsung Galaxy S23 ✅
  หมายเหตุ: ตัดสลับไปร้านคลองโยง

[ร้านคลองโยง]
- (ไม่มีการเปลี่ยนแปลง)

✅ ร้านศาลายามีบันทึก
✅ รู้ว่าเครื่องไปร้านคลองโยง
✅ สามารถติดตามได้
```

## 📁 ไฟล์ที่แก้ไข

| ไฟล์ | ฟังก์ชันที่แก้ | บรรทัด |
|------|---------------|--------|
| `script.js` | `confirmTransferToOtherStore()` | ~20 บรรทัด |

## 🧪 การทดสอบ

### Test Case 1: ตัดสลับร้านตัวเอง

**Pre-condition:**
- มีเครื่อง Samsung Galaxy S23 ในร้านศาลายา
- ราคาทุน: ฿15,000
- ราคาขาย: ฿19,000
- Status: stock

**Steps:**
1. คลิกปุ่ม "ตัด"
2. เลือก "ตัดสลับไปร้านตัวเอง"
3. Confirm "ตัดสลับไปร้านคลองโยง?"
4. คลิก "ตกลง"

**Expected Result:**
- ✅ แสดง Notification: "ตัดสลับไปร้านคลองโยง สำเร็จ (บันทึกในตัดออก)"
- ✅ เครื่องหายจาก Tab "สต๊อค"
- ✅ เครื่องแสดงใน Tab "ตัดออก"
- ✅ ราคาขาย: ฿19,000 (คงเดิม)
- ✅ หมายเหตุ: "ตัดสลับไปร้านคลองโยง"
- ✅ วันที่ขาย: วันที่ปัจจุบัน
- ✅ Dashboard อัพเดท (สต๊อคลด 1)

**Database Check:**
```sql
SELECT id, brand, model, status, sale_price, sale_date, note
FROM new_devices
WHERE id = 'DEVICE_ID';

-- Result:
-- status: 'removed'
-- sale_price: 19000
-- sale_date: '2025-10-31'
-- note: 'ตัดสลับไปร้านคลองโยง'
```

### Test Case 2: ตัดขายให้เจ้าอื่น (เปรียบเทียบ)

**Pre-condition:** เหมือน Test Case 1

**Steps:**
1. คลิกปุ่ม "ตัด"
2. เลือก "ตัดขายให้เจ้าอื่น"
3. แก้ไขราคาเป็น ฿18,000
4. กรอกหมายเหตุ: "ขายให้ร้านXXX"
5. คลิก "บันทึก"

**Expected Result:**
- ✅ เครื่องแสดงใน Tab "ตัดออก"
- ✅ ราคาขาย: ฿18,000 (ราคาที่แก้ไข)
- ✅ หมายเหตุ: "ขายให้ร้านXXX" (ที่กรอก)
- ✅ กำไร: ฿3,000

### Test Case 3: รองรับเครื่องมือสอง

**Pre-condition:**
- มีเครื่อง iPhone 12 Pro ในเมนู "เครื่องมือสอง"
- ร้านศาลายา
- Status: stock

**Steps:**
1. ไปเมนู "เครื่องมือสอง"
2. คลิกปุ่ม "ตัด"
3. เลือก "ตัดสลับไปร้านตัวเอง"
4. คลิก "ตกลง"

**Expected Result:**
- ✅ ทำงานเหมือนเครื่องใหม่
- ✅ บันทึกใน Tab "ตัดออก"
- ✅ API ใช้ `usedDevices` endpoint

## 📊 สรุป

### ✅ สิ่งที่ได้

1. **บันทึกครบถ้วน**
   - ทุกการตัดมีบันทึกใน Tab "ตัดออก"
   - ระบุปลายทางชัดเจน

2. **ติดตามได้**
   - รู้ว่าเครื่องไหนไปไหน
   - มีหมายเหตุบันทึกอัตโนมัติ

3. **ใช้งานง่าย**
   - ไม่ต้องแก้ไขราคา (ตัดสลับร้าน)
   - แก้ไขราคาได้ (ตัดขายให้เจ้าอื่น)

4. **สอดคล้องกัน**
   - เครื่องใหม่และเครื่องมือสองทำงานเหมือนกัน
   - Flow ชัดเจน เข้าใจง่าย

### 🔄 การเปลี่ยนแปลงหลัก

| หัวข้อ | เดิม | ใหม่ |
|--------|------|------|
| **บันทึก** | ไม่มี | มี (ใน "ตัดออก") |
| **ย้ายเครื่อง** | ย้ายจริง | ไม่ย้าย |
| **status** | stock (ร้านใหม่) | removed |
| **sale_date** | - | วันที่ปัจจุบัน |
| **note** | - | "ตัดสลับไปร้าน XXX" |
| **ราคาขาย** | คงเดิม | คงเดิม |

---

**เวอร์ชั่น:** 1.2  
**อัพเดท:** 31 ตุลาคม 2025  
**ระบบ:** iLovePhone Store Management System

