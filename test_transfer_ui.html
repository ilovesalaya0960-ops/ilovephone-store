<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        #logs {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-line {
            margin-bottom: 5px;
        }
        .log-success { color: #00ff00; }
        .log-error { color: #ff4444; }
        .log-info { color: #4af2f2; }
        .log-warning { color: #ffaa00; }
        .accessories-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .accessory-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .accessory-item:hover {
            background: #e8f4f8;
        }
        .accessory-item.selected {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô</h1>

        <div class="section">
            <h2>üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h2>
            <div class="form-group">
                <label>‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</label>
                <select id="sourceStore">
                    <option value="klongyong">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏•‡∏≠‡∏á‡πÇ‡∏¢‡∏á</option>
                    <option value="salaya">‡∏£‡πâ‡∏≤‡∏ô‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤</option>
                </select>
            </div>
            <button onclick="loadAccessories()">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
            <div id="accessoriesList" class="accessories-list" style="margin-top: 15px; display: none;"></div>
        </div>

        <div class="section">
            <h2>üéØ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢</h2>
            <div class="form-group">
                <label>‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á:</label>
                <select id="targetStore">
                    <option value="salaya">‡∏£‡πâ‡∏≤‡∏ô‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤</option>
                    <option value="klongyong">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏•‡∏≠‡∏á‡πÇ‡∏¢‡∏á</option>
                </select>
            </div>
            <div class="form-group">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢:</label>
                <input type="number" id="transferQuantity" value="1" min="1">
            </div>
            <button onclick="transferAccessory()">‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
        </div>

        <div class="section">
            <h2>üìù Logs</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api';
        let selectedAccessory = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const colors = {
                success: 'log-success',
                error: 'log-error',
                info: 'log-info',
                warning: 'log-warning'
            };
            const timestamp = new Date().toLocaleTimeString('th-TH');
            logs.innerHTML += `<div class="log-line ${colors[type]}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        async function loadAccessories() {
            try {
                const sourceStore = document.getElementById('sourceStore').value;
                log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏à‡∏≤‡∏Å ${sourceStore}...`, 'info');

                const response = await fetch(`${API_BASE}/accessories?store=${sourceStore}`);
                const accessories = await response.json();

                log(`‚úÖ ‡∏û‡∏ö ${accessories.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');

                const listEl = document.getElementById('accessoriesList');
                if (accessories.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>';
                } else {
                    listEl.innerHTML = accessories.map(acc => `
                        <div class="accessory-item" onclick="selectAccessory('${acc.id}')">
                            <strong>${acc.code}</strong> - ${acc.brand} ${acc.models}<br>
                            <small>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${acc.quantity} | ID: ${acc.id}</small>
                        </div>
                    `).join('');
                }
                listEl.style.display = 'block';
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function selectAccessory(id) {
            selectedAccessory = id;
            // Highlight selected
            document.querySelectorAll('.accessory-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.accessory-item').classList.add('selected');
            log(`‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ID: ${id}`, 'success');
        }

        async function transferAccessory() {
            if (!selectedAccessory) {
                log('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏Å‡πà‡∏≠‡∏ô!', 'warning');
                return;
            }

            try {
                const sourceStore = document.getElementById('sourceStore').value;
                const targetStore = document.getElementById('targetStore').value;
                const quantity = parseInt(document.getElementById('transferQuantity').value);

                if (sourceStore === targetStore) {
                    log('‚ö†Ô∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô!', 'warning');
                    return;
                }

                log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢...', 'info');

                // Step 1: Get accessory details
                log(`üìã Step 1: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà...`, 'info');
                const accRes = await fetch(`${API_BASE}/accessories/${selectedAccessory}`);
                const accessory = await accRes.json();
                log(`‚úÖ Code: ${accessory.code}, Quantity: ${accessory.quantity}`, 'success');

                if (quantity > accessory.quantity) {
                    log(`‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ${accessory.quantity} ‡∏ä‡∏¥‡πâ‡∏ô`, 'error');
                    return;
                }

                // Step 2: Update source store
                log(`üìâ Step 2: ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á...`, 'info');
                const newQuantity = accessory.quantity - quantity;
                const updateRes = await fetch(`${API_BASE}/accessories/${selectedAccessory}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...accessory,
                        quantity: newQuantity,
                        note: (accessory.note || '') + `\n‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ${targetStore} ${new Date().toISOString().split('T')[0]}: ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô`
                    })
                });
                await updateRes.json();
                log(`‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ${accessory.quantity} ‚Üí ${newQuantity}`, 'success');

                // Step 3: Check target store
                log(`üîç Step 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á...`, 'info');
                const targetRes = await fetch(`${API_BASE}/accessories?store=${targetStore}`);
                const targetAccessories = await targetRes.json();

                const existing = targetAccessories.find(a =>
                    a.type === accessory.type &&
                    a.code === accessory.code &&
                    a.brand === accessory.brand
                );

                if (existing) {
                    // Update existing
                    log(`‚úèÔ∏è ‡∏û‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß, ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô...`, 'info');
                    const updatedQty = existing.quantity + quantity;
                    await fetch(`${API_BASE}/accessories/${existing.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...existing,
                            quantity: updatedQty,
                            note: (existing.note || '') + `\n‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å${sourceStore} ${new Date().toISOString().split('T')[0]}: +${quantity} ‡∏ä‡∏¥‡πâ‡∏ô`
                        })
                    });
                    log(`‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: ${existing.quantity} ‚Üí ${updatedQty}`, 'success');
                } else {
                    // Create new
                    log(`‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á...`, 'info');
                    const newId = 'ACC' + Date.now();
                    const createRes = await fetch(`${API_BASE}/accessories`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: newId,
                            type: accessory.type,
                            code: accessory.code,
                            brand: accessory.brand,
                            models: accessory.models,
                            quantity: quantity,
                            cost_price: accessory.cost_price,
                            repair_price: accessory.repair_price,
                            import_date: new Date().toISOString().split('T')[0],
                            claim_quantity: 0,
                            cut_quantity: 0,
                            note: `‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å${sourceStore} ${new Date().toISOString().split('T')[0]}`,
                            store: targetStore
                        })
                    });
                    const result = await createRes.json();
                    log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà ID: ${result.id}`, 'success');
                }

                log(`üéâ ‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô ‡∏à‡∏≤‡∏Å ${sourceStore} ‚Üí ${targetStore}`, 'success');

                // Reload accessories
                await loadAccessories();

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
