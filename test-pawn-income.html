<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pawn Income Calculation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .income-breakdown {
            background: #fff3e0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
        }
        .income-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .total {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üîç Test Pawn Income Calculation</h1>
    
    <div class="card">
        <h2>Test API & Calculate Income</h2>
        <button onclick="testPawnIncome()">Test Income Calculation</button>
        <button onclick="testInterestTransactions()">Test Interest Transactions</button>
        <button onclick="clearResults()">Clear Results</button>
        <div id="testResults"></div>
    </div>

    <div class="card" id="incomeBreakdown" style="display:none;">
        <h2>üí∞ Income Breakdown</h2>
        <div class="income-breakdown">
            <div class="income-item">
                <span>üí∞ Deducted Interest (‡∏´‡∏±‡∏Å‡∏î‡∏≠‡∏Å‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ù‡∏≤‡∏Å):</span>
                <span id="deductedInterest">‡∏ø0</span>
            </div>
            <div class="income-item">
                <span>üíµ Returned Redemption (‡∏¢‡∏≠‡∏î‡πÑ‡∏ñ‡πà‡∏ñ‡∏≠‡∏ô):</span>
                <span id="returnedRedemption">‡∏ø0</span>
            </div>
            <div class="income-item">
                <span>üîÑ Renewal Interest (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏î‡∏≠‡∏Å):</span>
                <span id="renewalInterest">‡∏ø0</span>
            </div>
            <div class="income-item">
                <span>‚ö†Ô∏è Late Fee (‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö):</span>
                <span id="lateFee">‡∏ø0</span>
            </div>
            <div class="income-item total">
                <span>üìä TOTAL INCOME:</span>
                <span id="totalIncome">‡∏ø0</span>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api';
        const currentStore = 'salaya';

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('incomeBreakdown').style.display = 'none';
        }

        function formatCurrency(amount) {
            return '‡∏ø' + Number(amount).toLocaleString('th-TH');
        }

        async function testInterestTransactions() {
            clearResults();
            addResult('Testing Interest Transactions API...');
            
            try {
                const response = await fetch(`${API_BASE}/pawn-interest?store=${currentStore}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const transactions = await response.json();
                
                addResult(`‚úÖ Loaded ${transactions.length} interest transactions`, 'success');
                
                const renewalTransactions = transactions.filter(t => t.transaction_type === 'renewal');
                addResult(`üîÑ Renewal transactions: ${renewalTransactions.length}`, 'success');
                
                if (renewalTransactions.length > 0) {
                    renewalTransactions.forEach((t, index) => {
                        const interest = parseFloat(t.interest_amount) || 0;
                        const lateFee = parseFloat(t.late_fee) || 0;
                        const total = interest + lateFee;
                        
                        addResult(`  ${index + 1}. Date: ${t.transaction_date}, Interest: ${formatCurrency(interest)}, Late Fee: ${formatCurrency(lateFee)}, Total: ${formatCurrency(total)}`);
                    });
                    
                    const totalRenewal = renewalTransactions.reduce((sum, t) => {
                        return sum + (parseFloat(t.interest_amount) || 0) + (parseFloat(t.late_fee) || 0);
                    }, 0);
                    
                    addResult(`üí∞ Total Renewal Income: ${formatCurrency(totalRenewal)}`, 'success');
                }
            } catch (error) {
                addResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testPawnIncome() {
            clearResults();
            addResult('Testing Pawn Income Calculation...');
            
            try {
                // 1. Get all pawns
                const pawnResponse = await fetch(`${API_BASE}/pawn?store=${currentStore}`);
                if (!pawnResponse.ok) {
                    throw new Error(`HTTP error! status: ${pawnResponse.status}`);
                }
                const allPawns = await pawnResponse.json();
                addResult(`‚úÖ Loaded ${allPawns.length} pawn items`, 'success');

                // 2. Filter by status
                const activePawns = allPawns.filter(p => p.status === 'active');
                const returnedPawns = allPawns.filter(p => p.status === 'returned');
                
                addResult(`üìä Active pawns: ${activePawns.length}`, 'success');
                addResult(`üìä Returned pawns: ${returnedPawns.length}`, 'success');

                // 3. Calculate deducted interest
                const deductedPawns = activePawns.filter(p => p.interest_collection_method === 'deducted');
                const deductedInterest = deductedPawns.reduce((sum, pawn) => {
                    return sum + (parseFloat(pawn.interest) || 0);
                }, 0);
                
                addResult(`üí∞ Deducted Interest: ${formatCurrency(deductedInterest)} (from ${deductedPawns.length} pawns)`, 'success');

                // 4. Calculate returned redemption
                const returnedRedemption = returnedPawns.reduce((sum, pawn) => {
                    return sum + (parseFloat(pawn.redemption_amount) || 0);
                }, 0);
                
                addResult(`üíµ Returned Redemption: ${formatCurrency(returnedRedemption)}`, 'success');

                // 5. Get renewal interest from transactions
                const interestResponse = await fetch(`${API_BASE}/pawn-interest?store=${currentStore}`);
                if (!interestResponse.ok) {
                    throw new Error(`HTTP error! status: ${interestResponse.status}`);
                }
                const interestTransactions = await interestResponse.json();
                
                const renewalTransactions = interestTransactions.filter(t => t.transaction_type === 'renewal');
                const renewalInterest = renewalTransactions.reduce((sum, t) => {
                    const interest = parseFloat(t.interest_amount) || 0;
                    const lateFee = parseFloat(t.late_fee) || 0;
                    return sum + interest + lateFee;
                }, 0);
                
                // Separate interest and late fee
                const pureRenewalInterest = renewalTransactions.reduce((sum, t) => sum + (parseFloat(t.interest_amount) || 0), 0);
                const totalLateFee = renewalTransactions.reduce((sum, t) => sum + (parseFloat(t.late_fee) || 0), 0);
                
                addResult(`üîÑ Renewal Interest: ${formatCurrency(pureRenewalInterest)} (from ${renewalTransactions.length} renewals)`, 'success');
                addResult(`‚ö†Ô∏è Late Fee: ${formatCurrency(totalLateFee)}`, 'success');

                // 6. Calculate total income
                const totalIncome = deductedInterest + returnedRedemption + renewalInterest;
                
                addResult(`üìä TOTAL INCOME: ${formatCurrency(totalIncome)}`, 'success');

                // Show breakdown
                document.getElementById('incomeBreakdown').style.display = 'block';
                document.getElementById('deductedInterest').textContent = formatCurrency(deductedInterest);
                document.getElementById('returnedRedemption').textContent = formatCurrency(returnedRedemption);
                document.getElementById('renewalInterest').textContent = formatCurrency(pureRenewalInterest);
                document.getElementById('lateFee').textContent = formatCurrency(totalLateFee);
                document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);

                // Show expected vs actual
                const expected = 6100;
                if (Math.abs(totalIncome - expected) < 0.01) {
                    addResult(`‚úÖ CORRECT! Total income matches expected: ${formatCurrency(expected)}`, 'success');
                } else {
                    addResult(`‚ùå MISMATCH! Expected: ${formatCurrency(expected)}, Got: ${formatCurrency(totalIncome)}`, 'error');
                }

            } catch (error) {
                addResult(`‚ùå Error: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        }

        // Auto-run on load
        window.onload = () => {
            setTimeout(() => {
                testPawnIncome();
            }, 500);
        };
    </script>
</body>
</html>

